{% extends "main_frame.html" %}
{% block conten_body %}
<script type="text/javascript" src="{{url_for('static', filename='js/jquery.md5.js')}}"></script>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/tree_style.css') }}" />
<script type="text/javascript" src="{{url_for('static', filename='js/SkyRTC-client.js')}}"></script>
	<div class="user_info_div">
        <h2 class="title">视频通话</h2>
        <div style="width: 100%;">
	        <div id="videos"></div>
		</div>
	</div>

{% endblock %}

{% block script %}
	<script type="text/javascript">
		var rtc = SkyRTC();
		
		function creatVideoDOM(id){
			var videos = $('#videos');
			var newVideoDiv = $(document.createElement("div"))
				.attr({
					"style": "width: auto;height: auto;border-radius: 10px;background-color: #FFFFFF;margin: 10px;padding: 10px 10px 30px 10px;"
				});
			var newVideo = $(document.createElement("video"))
				.attr({
					"id": id,
					"controls": "true",
					"autoplay": "true",
					"style": "display: block;max-width: 100%;width: atuo;height: auto;margin-left: auto;margin-right: auto;border: 2px;border-style: solid;border-color: #000000;"
				});
			newVideoDiv.append(newVideo);
			videos.append(newVideoDiv);
			return newVideo.get(0);
		}
		//成功创建WebSocket连接
		rtc.on("connected", function(socket) {
			//创建本地视频流
			rtc.createStream({
				"video": true,
				"audio": true
			});
		});
		//创建本地视频流成功
		rtc.on("stream_created", function(stream) {
			var newVideo = creatVideoDOM('me');
			newVideo.src = URL.createObjectURL(stream);
    		newVideo.play();
		});
		//创建本地视频流失败
		rtc.on("stream_create_error", function(error) {
			console.log(error);
			console.log("create video stream failed!");
		});
		//接收到其他用户的视频流
		rtc.on('pc_add_stream', function(stream, socketId) {
			var	id = "other-" + socketId;
			var newVideo = creatVideoDOM(id);
			rtc.attachStream(stream, id);
		});
		//删除其他用户
		rtc.on('remove_peer', function(socketId) {
			var video = $('#other-' + socketId);
			if(video.get().length > 0){
				video.parent().remove();
			}
		});
		
	</script>
	
	<script type="text/javascript">
	{% autoescape false %}
		{% if room %}
			var video_room = '{{ room }}';
			var skyrtc_server_port = '{{ skyrtc_server_port }}';
			//连接WebSocket服务器
			rtc.connect('ws://' + document.domain + ':' + skyrtc_server_port, video_room);
		{% endif %}
	{% endautoescape %}
	</script>
{% endblock %}